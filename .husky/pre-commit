#!/usr/bin/env bash

# Pre-commit Hook with Constitutional Compliance
# This hook ensures all changes comply with constitutional standards before commit

echo "ðŸ” Running constitutional compliance checks..."

# Check if CONSTITUTION.md exists
if [ ! -f "CONSTITUTION.md" ]; then
    echo "âŒ CONSTITUTION.md not found. Constitutional compliance cannot be verified."
    exit 1
fi

# Run constitutional validation
echo "ðŸ“‹ Validating constitutional compliance..."
if [ -f "constitutional_checks.yml" ]; then
    echo "âœ… Constitutional checks file exists"
    # Simple validation without Python dependency
    if grep -q "enabled: true" constitutional_checks.yml; then
        echo "âœ… Constitutional checks are enabled"
    else
        echo "âš ï¸  Some constitutional checks may be disabled"
    fi
else
    echo "âŒ constitutional_checks.yml not found"
    exit 1
fi

# Check if spec-kit is installed
if [ ! -d ".specify" ]; then
    echo "âŒ Spec-kit directory not found. Please run spec-kit initialization."
    exit 1
fi

# Run linting if configured
if command -v npm &> /dev/null; then
    echo "ðŸ”§ Running linting checks..."
    if npm run lint 2>/dev/null; then
        echo "âœ… Linting passed"
    else
        echo "âš ï¸  Linting issues found but continuing..."
    fi
fi

# Run tests if configured
if command -v npm &> /dev/null; then
    echo "ðŸ§ª Running tests..."
    if npm run test 2>/dev/null; then
        echo "âœ… Tests passed"
    else
        echo "âš ï¸  Test issues found but continuing..."
    fi
fi

# Run security scanning if configured
if command -v npm &> /dev/null; then
    echo "ðŸ”’ Running security scanning..."
    npm audit 2>/dev/null || echo "âš ï¸  Security issues found but continuing..."
fi

# Log constitutional compliance
echo "ðŸ“ Logging constitutional compliance..."
mkdir -p .constitutional
echo "$(date): Pre-commit constitutional validation passed" >> .constitutional/audit.log

echo "âœ… Constitutional compliance checks completed"
exit 0